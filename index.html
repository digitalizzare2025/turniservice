<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>TurniService - Gestione Turni Forze dell'Ordine</title>
  <meta name="theme-color" content="#1f3fa3">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="favicon.ico">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- FullCalendar CSS (FIX) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" rel="stylesheet">
  <!-- Icone -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    body { background:#f4f6f8; }
    header.navbar { background:#223ea8; }
    header .navbar-brand, header .nav-link, header .navbar-text { color:#fff !important; }
    .page { display:none; }
    .page.active { display:block; }
    .card { border-radius: 12px; }
    .quick-action .btn { width:100%; height:64px; }
    #chart-indennita { min-height: 280px; display: block; }
    #calendario-app { min-height: 520px; }
    #auth-overlay { position: fixed; inset: 0; background: #ffffff; z-index: 9999; overflow: auto; }
    .turno-sera{} .turno-pomeriggio{} .turno-mattina{} .turno-notte{} .turno-riposo{}
  </style>
</head>
<body>

  <!-- NAVBAR -->
  <header class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <i class="bi bi-shield-lock"></i> <span>TurniService</span>
      </a>
      <div class="ms-auto d-flex align-items-center gap-2">
        <span id="badge-status" class="badge bg-secondary">Offline</span>
        <span id="user-email" class="text-white-50 small"></span>
        <button class="btn btn-light btn-sm d-none" id="btn-profile"><i class="bi bi-person-circle me-1"></i>Profilo</button>
        <button class="btn btn-danger btn-sm d-none" id="btn-logout" title="Esci"><i class="bi bi-box-arrow-right"></i></button>
      </div>
    </div>
  </header>

  <!-- TABS -->
  <nav class="border-bottom bg-white">
    <div class="container py-2">
      <ul class="nav nav-tabs" id="mainTabs">
        <li class="nav-item"><a class="nav-link active" data-target="page-dashboard" href="#">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" data-target="page-calendario" href="#">Calendario</a></li>
        <li class="nav-item"><a class="nav-link" data-target="page-agenda" href="#">Agenda</a></li>
        <li class="nav-item"><a class="nav-link" data-target="page-assenze" href="#">Assenze</a></li>
        <li class="nav-item"><a class="nav-link" data-target="page-ricerca" href="#">Ricerca</a></li>
      </ul>
    </div>
  </nav>

  <main class="container my-4">

    <!-- DASHBOARD -->
    <section id="page-dashboard" class="page active">
      <div class="row g-3">
        <div class="col-12 col-md-3">
          <div class="card"><div class="card-body">
            <div class="d-flex align-items-center gap-3">
              <div class="display-6">€</div>
              <div>
                <div class="small text-muted">Indennità Mese</div>
                <div class="fw-bold fs-4" id="val-indennita-mese">€0,00</div>
              </div>
            </div>
          </div></div>
        </div>
        <div class="col-12 col-md-3">
          <div class="card"><div class="card-body">
            <div class="small text-muted">Ore Straordinario</div>
            <div class="fw-bold fs-4" id="val-straordinario">0</div>
          </div></div>
        </div>
        <div class="col-12 col-md-3">
          <div class="card"><div class="card-body">
            <div class="small text-muted">Giorni Congedo</div>
            <div class="fw-bold fs-4" id="val-congedo">0</div>
          </div></div>
        </div>
        <div class="col-12 col-md-3">
          <div class="card"><div class="card-body">
            <div class="small text-muted">Turni Mese</div>
            <div class="fw-bold fs-4" id="val-turni-mese">0</div>
          </div></div>
        </div>
      </div>

      <div class="card my-4">
        <div class="card-body">
          <h5 class="mb-3">Azioni Rapide</h5>
          <div class="row g-3">
            <div class="col-12 col-md-6 col-lg-3"><button class="btn btn-primary quick-action" data-bs-toggle="modal" data-bs-target="#modalAddTurno"><i class="bi bi-plus-circle me-2"></i>Aggiungi Turno</button></div>
            <div class="col-12 col-md-6 col-lg-3"><button class="btn btn-success quick-action" data-bs-toggle="modal" data-bs-target="#modalAddIndennita"><i class="bi bi-currency-euro me-2"></i>Indennità</button></div>
            <div class="col-12 col-md-6 col-lg-3"><button class="btn btn-danger quick-action" data-bs-toggle="modal" data-bs-target="#modalAddAssenza"><i class="bi bi-calendar-x me-2"></i>Assenza</button></div>
            <div class="col-12 col-md-6 col-lg-3"><button class="btn btn-secondary quick-action" id="btn-backup"><i class="bi bi-download me-2"></i>Backup</button></div>
          </div>
        </div>
      </div>

      <div class="card my-4">
        <div class="card-body">
          <h5 class="mb-3">Andamento Indennità Mensili</h5>
          <div style="height:320px">
            <canvas id="chart-indennita" role="img" aria-label="Andamento Indennità Mensili"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- CALENDARIO -->
    <section id="page-calendario" class="page">
      <div class="card">
        <div class="card-body">
          <h4 class="mb-3">Calendario</h4>
          <div class="mb-2 small">
            <span class="me-3"><span class="badge bg-light text-dark">Sera</span></span>
            <span class="me-3"><span class="badge bg-light text-dark">Pomeriggio</span></span>
            <span class="me-3"><span class="badge bg-light text-dark">Mattina</span></span>
            <span class="me-3"><span class="badge bg-light text-dark">Notte</span></span>
            <span class="me-3"><span class="badge bg-light text-dark">Riposo</span></span>
            <span class="me-3"><span class="badge bg-success">Assenze</span></span>
          </div>
          <div id="calendario-app" aria-label="Calendario turni"></div>
        </div>
      </div>
    </section>

    <!-- AGENDA -->
    <section id="page-agenda" class="page">
      <div class="card mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Agenda</h4>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAddTurno"><i class="bi bi-plus-circle me-2"></i>Aggiungi Turno</button>
          </div>
        </div>
      </div>

      <!-- Generatore turnazione in quinta -->
      <div class="card mb-3" id="turnazione-quinta">
        <div class="card-body">
          <h5 class="mb-3">Imposta Turnazione in Quinta</h5>
          <div class="row g-3 align-items-end">
            <div class="col-12 col-md-3">
              <label for="r-start" class="form-label">Data inizio</label>
              <input type="date" id="r-start" class="form-control">
            </div>
            <div class="col-12 col-md-3">
              <label for="r-end" class="form-label">Data fine</label>
              <input type="date" id="r-end" class="form-control">
            </div>
            <div class="col-12 col-md-3">
              <label for="r-start-shift" class="form-label">Turno iniziale</label>
              <select id="r-start-shift" class="form-select">
                <option value="sera">Sera</option>
                <option value="pomeriggio">Pomeriggio</option>
                <option value="mattina">Mattina</option>
                <option value="notte">Notte</option>
                <option value="riposo">Riposo</option>
              </select>
            </div>
            <div class="col-12 col-md-3">
              <button id="r-genera" class="btn btn-success w-100"><i class="bi bi-arrow-repeat me-2"></i>Genera turni</button>
            </div>
          </div>
          <p id="r-esito" class="mt-2 small text-muted" aria-live="polite"></p>
        </div>
      </div>

      <!-- Lista agenda -->
      <div class="card">
        <div class="card-body">
          <div id="agenda-list" class="vstack gap-3"></div>
        </div>
      </div>
    </section>

    <!-- ASSENZE -->
    <section id="page-assenze" class="page">
      <div class="card">
        <div class="card-body">
          <h4 class="mb-3">Gestione Assenze</h4>
          <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalAddAssenza">Aggiungi Assenza</button>
          <div class="row mt-4">
            <div class="col-6 col-md-3"><div class="border rounded p-3"><div class="small text-muted">Congedi Ordinari</div><div class="fs-4 fw-bold">0</div></div></div>
            <div class="col-6 col-md-3"><div class="border rounded p-3"><div class="small text-muted">Congedi Straordinari</div><div class="fs-4 fw-bold">0</div></div></div>
            <div class="col-6 col-md-3"><div class="border rounded p-3"><div class="small text-muted">Permessi Brevi</div><div class="fs-4 fw-bold">0</div></div></div>
            <div class="col-6 col-md-3"><div class="border rounded p-3"><div class="small text-muted">Riposi Legge</div><div class="fs-4 fw-bold">0</div></div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- RICERCA -->
    <section id="page-ricerca" class="page">
      <div class="card">
        <div class="card-body">
          <h4 class="mb-3">Ricerca</h4>
          <form id="form-ricerca" class="row g-3">
            <div class="col-12 col-md-3">
              <label class="form-label">Tipo</label>
              <select class="form-select" id="ricerca-tipo">
                <option value="tutti">Tutti</option>
                <option value="turni">Turni</option>
                <option value="assenze">Assenze</option>
                <option value="indennita">Indennità</option>
              </select>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label">Data Da</label>
              <input type="date" class="form-control" id="ricerca-da">
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label">Data A</label>
              <input type="date" class="form-control" id="ricerca-a">
            </div>
            <div class="col-12 col-md-3 d-flex align-items-end">
              <button class="btn btn-primary w-100" type="submit">Cerca</button>
            </div>
          </form>
          <div id="ricerca-risultati" class="mt-3"></div>
        </div>
      </div>
    </section>

  </main>

  <!-- MODAL: Aggiungi Turno -->
  <div class="modal fade" id="modalAddTurno" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="form-add-turno">
        <div class="modal-header">
          <h5 class="modal-title">Aggiungi Turno</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Data</label>
            <input type="date" class="form-control" id="turno-data" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Tipo Turno</label>
            <select class="form-select" id="turno-tipo" required>
              <option value="">Seleziona...</option>
              <option value="sera">Sera</option>
              <option value="pomeriggio">Pomeriggio</option>
              <option value="mattina">Mattina</option>
              <option value="notte">Notte</option>
              <option value="riposo">Riposo</option>
            </select>
          </div>
          <div>
            <label class="form-label">Note</label>
            <textarea class="form-control" id="turno-note" rows="2"></textarea>
          </div>
          <div class="text-danger small mt-2 d-none" id="err-turno"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Annulla</button>
          <button class="btn btn-primary" type="submit">Salva</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL: Aggiungi Indennità -->
  <div class="modal fade" id="modalAddIndennita" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="form-add-indennita">
        <div class="modal-header">
          <h5 class="modal-title">Aggiungi Indennità</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Data</label>
            <input type="date" class="form-control" id="ind-data" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Tipo Indennità</label>
            <select class="form-select" id="ind-tipo" required>
              <option value="">Seleziona...</option>
              <option>Ordine Pubblico</option>
              <option>Servizio Esterno</option>
              <option>Cambio Turno</option>
              <option>Missione</option>
              <option>Reperibilità</option>
              <option>Rimborso Forfettario</option>
              <option>Buono Pasto</option>
              <option>Straordinario Emergente</option>
              <option>Straordinario Programmato</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Importo (€)</label>
            <input type="number" step="0.01" min="0" class="form-control" id="ind-importo" required>
          </div>
          <div>
            <label class="form-label">Note</label>
            <textarea class="form-control" id="ind-note" rows="2"></textarea>
          </div>
          <div class="text-danger small mt-2 d-none" id="err-indennita"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Annulla</button>
          <button class="btn btn-primary" type="submit">Salva</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL: Aggiungi Assenza -->
  <div class="modal fade" id="modalAddAssenza" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="form-add-assenza">
        <div class="modal-header">
          <h5 class="modal-title">Aggiungi Assenza</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Data Inizio</label>
            <input type="date" class="form-control" id="ass-start" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Data Fine</label>
            <input type="date" class="form-control" id="ass-end" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Tipo Assenza</label>
            <select class="form-select" id="ass-tipo" required>
              <option value="">Seleziona...</option>
              <option>Congedo Ordinario</option>
              <option>Congedo Straordinario per Malattia</option>
              <option>Congedo Straordinario per Esami</option>
              <option>Congedo Straordinario per Gravi Motivi Familiari</option>
              <option>Congedo Straordinario per Trasferimento</option>
              <option>Riposo Legge</option>
              <option>Riposo Settimanale</option>
              <option>Riposo Festivo</option>
              <option>Riposo Compensativo</option>
              <option>Aspettativa</option>
              <option>Legge 104</option>
              <option>Donazione Sangue</option>
              <option>Ore di Studio</option>
              <option>Permesso Breve</option>
              <option>Permesso Sindacale</option>
            </select>
          </div>
          <div>
            <label class="form-label">Note</label>
            <textarea class="form-control" id="ass-note" rows="2"></textarea>
          </div>
          <div class="text-danger small mt-2 d-none" id="err-assenza"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Annulla</button>
          <button class="btn btn-primary" type="submit">Salva</button>
        </div>
      </form>
    </div>
  </div>

  <!-- OVERLAY LOGIN (SUPABASE MAGIC LINK) -->
  <div id="auth-overlay">
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <h3 class="mb-3">Accedi</h3>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" id="auth-email" class="form-control" placeholder="nome@dominio.it">
              </div>
              <div class="d-grid gap-2">
                <button class="btn btn-primary" id="btn-send-magic">Invia Link Magico</button>
              </div>
              <div id="auth-msg" class="small text-muted mt-3" aria-live="polite"></div>
              <div class="alert alert-warning mt-3 d-none" id="diag-panel"></div>
              <hr class="my-3">
              <p class="small text-muted">
                Dopo aver cliccato il link nell'email, verrai reindirizzato qui e l’accesso sarà automatico.
              </p>
            </div>
          </div>
          <p class="text-center text-muted mt-3">PWA offline: i dati si sincronizzano quando torni online</p>
        </div>
      </div>
    </div>
  </div>

  <!-- LIBRERIE -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <!-- FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <!-- SDK Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <script>
  /* ========= CONFIG ========= */
  const SUPABASE_URL = "https://rqmltortearagsshvokr.supabase.co";   // <-- Sostituisci
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxbWx0b3J0ZWFyYWdzc2h2b2tyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4ODE4ODQsImV4cCI6MjA3MjQ1Nzg4NH0.rFQLx7LDoEQ2hSNtvfDCb4m0rUMMzsSL72z-_RhYljU";                      // <-- Sostituisci
  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
  });

  const LS_KEYS = { CAL:'turni_calendario_cache', IND:'indennita_mensili_cache', ABS:'assenze_cache' };
  const getJSON = (k, def=[]) => { try { return JSON.parse(localStorage.getItem(k) || JSON.stringify(def)); } catch { return def; } };
  const setJSON = (k,v) => localStorage.setItem(k, JSON.stringify(v));
  const fmtISO = d => d.toISOString().slice(0,10);
  const parseISO = s => new Date(s+'T00:00:00');
  function* daysRange(d1,d2){ const c=new Date(d1.getFullYear(),d1.getMonth(),d1.getDate()); const e=new Date(d2.getFullYear(),d2.getMonth(),d2.getDate()); while(c<=e){ yield new Date(c); c.setDate(c.getDate()+1);} }
  const $ = sel => document.querySelector(sel);

  /* ========= DIAGNOSTICA ========= */
  async function diagSupabase(reason=''){
    const panel = $('#diag-panel');
    try{
      const res = await fetch(`${SUPABASE_URL}/auth/v1/settings`, { headers:{ apikey: SUPABASE_ANON_KEY } });
      if(res.ok){ panel.classList.add('d-none'); return true; }
      panel.classList.remove('d-none'); panel.innerHTML = `Endpoint raggiunto ma risposta ${res.status}. Verifica Redirect URLs e chiave anon. ${reason}`;
      return false;
    }catch(e){
      panel.classList.remove('d-none'); panel.innerHTML = `Impossibile contattare Supabase. Controlla <code>SUPABASE_URL</code>. Dettaglio: ${e.message}`;
      return false;
    }
  }

  /* ========= AUTH ========= */
  async function checkSessionUI(){
    const { data:{ session } } = await supa.auth.getSession();
    const overlay = $('#auth-overlay'), badge = $('#badge-status'), emailTxt = $('#user-email'), btnLogout = $('#btn-logout');
    if(session?.user){
      overlay.style.display='none';
      badge.classList.replace('bg-secondary','bg-success'); badge.textContent='Online';
      emailTxt.textContent=session.user.email||''; btnLogout.classList.remove('d-none'); $('#btn-profile')?.classList.remove('d-none');
      await loadAllDataAndRender();
    } else {
      overlay.style.display=''; badge.classList.replace('bg-success','bg-secondary'); badge.textContent='Offline';
      emailTxt.textContent=''; btnLogout.classList.add('d-none'); $('#btn-profile')?.classList.add('d-none');
      renderCalendar([]); renderAgendaList('#agenda-list',[]); renderIndennitaChartPlaceholder();
    }
  }

  $('#btn-send-magic')?.addEventListener('click', async (e)=>{
    e.preventDefault();
    const email = $('#auth-email').value.trim(); const msg = $('#auth-msg');
    if(!email){ msg.textContent='Inserisci una email valida.'; return; }
    msg.textContent='Invio link magico...'; await diagSupabase('(prima dell\'invio)');
    try{
      const { error } = await supa.auth.signInWithOtp({ email, options:{ emailRedirectTo:'https://digitalizzare2025.github.io/turniservice/' } });
      msg.textContent = error ? ('Errore: '+(error.message||'sconosciuto')) : 'Email inviata! Controlla la casella e clicca sul link.';
      if(error) await diagSupabase('(errore invio)');
    }catch(err){ msg.textContent='Errore: '+(err.message||'Failed to fetch'); await diagSupabase('(eccezione client)'); }
  });

  $('#btn-logout')?.addEventListener('click', async ()=>{ await supa.auth.signOut(); await checkSessionUI(); });
  supa.auth.onAuthStateChange(async ()=>{ await checkSessionUI(); });

  /* ========= DATA LAYER ========= */
  async function getUserId(){ const { data:{ user } } = await supa.auth.getUser(); return user?.id||null; }

  // Shifts
  async function fetchShifts(){
    const uid = await getUserId(); if(!uid) return [];
    const { data, error } = await supa.from('shifts').select('*').eq('user_id', uid).order('date');
    if(error){ console.warn('fetchShifts', error); return getJSON(LS_KEYS.CAL,[]); }
    setJSON(LS_KEYS.CAL, data||[]); return data||[];
  }
  async function upsertShifts(rows){
    const uid = await getUserId(); if(!uid) throw new Error('Utente non autenticato');
    const payload = rows.map(r=>({ ...r, user_id: uid }));
    const { error } = await supa.from('shifts').upsert(payload, { onConflict:'user_id,date,tipo' });
    if(error) throw error;
  }
  async function deleteShift(id){
    const uid = await getUserId(); if(!uid) throw new Error('Utente non autenticato');
    const { error } = await supa.from('shifts').delete().eq('id', id).eq('user_id', uid);
    if(error) throw error;
  }

  // Allowances
  async function fetchAllowances(){
    const uid = await getUserId(); if(!uid) return [];
    const { data, error } = await supa.from('allowances').select('*').eq('user_id', uid).order('date');
    if(error){ console.warn('fetchAllowances', error); return getJSON(LS_KEYS.IND,[]); }
    setJSON(LS_KEYS.IND, data||[]); return data||[];
  }
  async function insertAllowance(row){
    const uid = await getUserId(); if(!uid) throw new Error('Utente non autenticato');
    const { error } = await supa.from('allowances').insert({ ...row, user_id: uid });
    if(error) throw error;
  }

  // Absences
  async function fetchAbsences(){
    const uid = await getUserId(); if(!uid) return [];
    const { data, error } = await supa.from('absences').select('*').eq('user_id', uid).order('start_date');
    if(error){ console.warn('fetchAbsences', error); return getJSON(LS_KEYS.ABS,[]); }
    setJSON(LS_KEYS.ABS, data||[]); return data||[];
  }
  async function insertAbsence(row){
    const uid = await getUserId(); if(!uid) throw new Error('Utente non autenticato');
    const { error } = await supa.from('absences').insert({ ...row, user_id: uid });
    if(error) throw error;
  }

  /* ========= RENDER ========= */
  let _calendar, _chart;
  function mapShiftsToEvents(shifts){
    const titleMap={sera:'Turno sera',pomeriggio:'Turno pomeriggio',mattina:'Turno mattina',notte:'Turno notte',riposo:'Riposo'};
    const classMap={sera:'turno-sera',pomeriggio:'turno-pomeriggio',mattina:'turno-mattina',notte:'turno-notte',riposo:'turno-riposo'};
    return (shifts||[]).map(s=>({ id:s.id, title:titleMap[s.tipo]||s.tipo, start:s.date, allDay:true, className:classMap[s.tipo]||'', extendedProps:{ tipo:s.tipo, origin:s.origin||'manual' } }));
  }
  function renderCalendar(events){
    const el = document.getElementById('calendario-app');
    if(!_calendar){
      _calendar = new FullCalendar.Calendar(el,{ initialView:'dayGridMonth', height:'auto', fixedWeekCount:false, showNonCurrentDates:true, dayMaxEvents:true, events:events||[] });
      _calendar.render();
      window._calendar=_calendar;
    } else {
      _calendar.removeAllEvents(); _calendar.addEventSource(events||[]); _calendar.updateSize();
    }
  }
  function renderAgendaList(sel, events){
    const el = document.querySelector(sel); if(!el) return;
    const items=[...(events||[])].sort((a,b)=>a.start<b.start?-1:1);
    el.innerHTML='';
    for(const ev of items){
      const d=new Date(ev.start);
      const div=document.createElement('div');
      div.className='border rounded p-3';
      div.innerHTML=`<div class="d-flex justify-content-between align-items-center">
        <div><div class="fw-bold">${d.toLocaleDateString('it-IT',{weekday:'long',day:'2-digit',month:'long',year:'numeric'})}</div>
        <div class="text-muted small">${ev.title}</div></div>
        <div class="d-flex gap-3"><a href="#" class="link-danger" data-del="${ev.id}">Elimina</a></div></div>`;
      el.appendChild(div);
    }
    el.querySelectorAll('[data-del]')?.forEach(a=>{
      a.addEventListener('click', async (e)=>{
        e.preventDefault();
        const id=a.getAttribute('data-del');
        try{ await deleteShift(id); await loadAllDataAndRender(); }
        catch(err){ let c=getJSON(LS_KEYS.CAL,[]); c=c.filter(x=>x.id!==id); setJSON(LS_KEYS.CAL,c); renderCalendar(mapShiftsToEvents(c)); renderAgendaList('#agenda-list', mapShiftsToEvents(c)); }
      });
    });
  }
  function renderIndennitaChartPlaceholder(){
    const el=document.getElementById('chart-indennita'); if(!el) return;
    const labels=['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'], values=Array(12).fill(0);
    if(_chart) _chart.destroy();
    _chart=new Chart(el,{type:'line',data:{labels,datasets:[{label:'Indennità',data:values,tension:0.3,fill:false}]},options:{maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}});
  }
  function renderIndennitaChartFromAllowances(allowances){
    const el=document.getElementById('chart-indennita'); if(!el) return;
    const labels=['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'], values=Array(12).fill(0);
    for(const a of (allowances||[])){ const m=new Date(a.date).getMonth(); const val=parseFloat(a.importo||0); values[m]+=isNaN(val)?0:val; }
    if(_chart) _chart.destroy();
    _chart=new Chart(el,{type:'line',data:{labels,datasets:[{label:'Indennità',data:values,tension:0.3,fill:false}]},options:{maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}});
  }

  /* ========= LOAD & SYNC ========= */
  async function loadAllDataAndRender(){
    try{
      const [shifts, allowances] = await Promise.all([fetchShifts(), fetchAllowances()]);
      const events = mapShiftsToEvents(shifts);
      renderCalendar(events); renderAgendaList('#agenda-list', events); renderIndennitaChartFromAllowances(allowances);
    } catch(err){
      console.warn('loadAllData error, uso cache', err);
      const cS=getJSON(LS_KEYS.CAL,[]), cA=getJSON(LS_KEYS.IND,[]);
      renderCalendar(mapShiftsToEvents(cS)); renderAgendaList('#agenda-list', mapShiftsToEvents(cS)); renderIndennitaChartFromAllowances(cA);
    }
  }

  /* ========= NAV ========= */
  (function tabs(){
    const pages=document.querySelectorAll('.page');
    document.getElementById('mainTabs')?.addEventListener('click',(e)=>{
      const a=e.target.closest('a[data-target]'); if(!a) return; e.preventDefault();
      document.querySelectorAll('#mainTabs .nav-link').forEach(el=>el.classList.remove('active'));
      a.classList.add('active'); pages.forEach(p=>p.classList.remove('active'));
      document.getElementById(a.dataset.target)?.classList.add('active');
      if(a.dataset.target==='page-calendario' && window._calendar){ setTimeout(()=>window._calendar.updateSize(),50); }
    });
  })();

  /* ========= FORMS ========= */
  // Turno
  document.getElementById('form-add-turno')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const data=$('#turno-data').value, tipo=$('#turno-tipo').value, note=$('#turno-note').value||null, err=$('#err-turno');
    err.classList.add('d-none'); err.textContent='';
    if(!data||!tipo){ err.textContent='Compila data e tipo turno.'; err.classList.remove('d-none'); return; }
    try{ await upsertShifts([{ date:data, tipo, note, origin:'manual' }]); await loadAllDataAndRender(); document.querySelector('#modalAddTurno .btn-close').click(); }
    catch(ex){ err.textContent='Errore salvataggio: '+(ex?.message||'verifica permessi RLS'); err.classList.remove('d-none'); }
  });

  // Indennità
  document.getElementById('form-add-indennita')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const data=$('#ind-data').value, tipo=$('#ind-tipo').value, importo=parseFloat($('#ind-importo').value||'0'), note=$('#ind-note').value||null, err=$('#err-indennita');
    err.classList.add('d-none'); err.textContent='';
    if(!data||!tipo||isNaN(importo)){ err.textContent='Compila tutti i campi.'; err.classList.remove('d-none'); return; }
    try{ await insertAllowance({ date:data, tipo, importo, note }); await loadAllDataAndRender(); document.querySelector('#modalAddIndennita .btn-close').click(); }
    catch(ex){ err.textContent='Errore salvataggio: '+(ex?.message||'verifica permessi RLS'); err.classList.remove('d-none'); }
  });

  // Assenza
  document.getElementById('form-add-assenza')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const start=$('#ass-start').value, end=$('#ass-end').value, tipo=$('#ass-tipo').value, note=$('#ass-note').value||null, err=$('#err-assenza');
    err.classList.add('d-none'); err.textContent='';
    if(!start||!end||!tipo){ err.textContent='Compila tutti i campi.'; err.classList.remove('d-none'); return; }
    try{ await insertAbsence({ start_date:start, end_date:end, tipo, note }); document.querySelector('#modalAddAssenza .btn-close').click(); }
    catch(ex){ err.textContent='Errore salvataggio: '+(ex?.message||'verifica permessi RLS'); err.classList.remove('d-none'); }
  });

  /* ========= AGENDA: turnazione in quinta ========= */
  (function agendaRotation(){
    const SEQ=['sera','pomeriggio','mattina','notte','riposo'];
    function generateRotation({start,end,startShift}){ const i0=SEQ.indexOf(startShift); if(i0<0) throw new Error('Turno iniziale non valido'); const rows=[]; let i=0; for(const d of daysRange(start,end)){ const tipo=SEQ[(i0+i)%SEQ.length]; rows.push({ date:fmtISO(d), tipo, note:null, origin:'auto' }); i++; } return rows; }
    document.getElementById('r-genera')?.addEventListener('click', async ()=>{
      const ds=$('#r-start').value, de=$('#r-end').value, shift=$('#r-start-shift').value, out=$('#r-esito');
      try{
        if(!ds||!de||!shift) throw new Error('Compila data inizio, data fine e turno iniziale.');
        const d1=parseISO(ds), d2=parseISO(de); if(d2<d1) throw new Error('La data di fine deve essere successiva a quella di inizio.');
        const rows=generateRotation({ start:d1, end:d2, startShift:shift });
        await upsertShifts(rows); await loadAllDataAndRender(); out.textContent=`Generati ${rows.length} turni fino al ${de}.`;
      } catch(ex){ out.textContent=ex.message||'Errore generazione.'; }
    });
  })();

  /* ========= BACKUP ========= */
  document.getElementById('btn-backup')?.addEventListener('click', async ()=>{
    try{
      const [shifts, allowances, absences] = await Promise.all([
        fetchShifts().catch(()=>getJSON(LS_KEYS.CAL,[])),
        fetchAllowances().catch(()=>getJSON(LS_KEYS.IND,[])),
        fetchAbsences().catch(()=>getJSON(LS_KEYS.ABS,[]))
      ]);
      const payload = { exported_at: new Date().toISOString(), shifts, allowances, absences };
      const blob = new Blob([JSON.stringify(payload,null,2)], { type:'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `turniservice-backup-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a); a.click(); a.remove();
    } catch(ex){
      alert('Backup non riuscito: '+(ex?.message||'errore sconosciuto'));
    }
  });

  /* ========= CHART placeholder + INIT ========= */
  function renderIndennitaChartPlaceholder(){ const el=document.getElementById('chart-indennita'); if(!el) return;
    const labels=['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'], values=Array(12).fill(0);
    if(window._chart) window._chart.destroy();
    window._chart=new Chart(el,{type:'line',data:{labels,datasets:[{label:'Indennità',data:values,tension:0.3,fill:false}]},options:{maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}});
  }
  renderIndennitaChartPlaceholder();
  checkSessionUI();

  /* ========= Service Worker ATTIVO ========= */
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }
  </script>
</body>
</html>
