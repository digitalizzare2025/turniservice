<button type="button" onclick="closeModal('shift-modal')" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded hover:bg-gray-300">
                        Annulla
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700">
                        Salva
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Allowance Modal -->
    <div id="allowance-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold">Aggiungi Indennità</h3>
                <button onclick="closeModal('allowance-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form onsubmit="saveAllowance(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                        <input type="date" id="allowance-date" class="w-full p-2 border border-gray-300 rounded" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo Indennità</label>
                        <select id="allowance-type" class="w-full p-2 border border-gray-300 rounded" required>
                            <option value="">Seleziona...</option>
                            <option value="ordine-pubblico">Ordine Pubblico</option>
                            <option value="servizio-esterno">Servizio Esterno</option>
                            <option value="cambio-turno">Cambio Turno</option>
                            <option value="missione">Missione</option>
                            <option value="reperibilita">Reperibilità</option>
                            <option value="rimborso-forfettario">Rimborso Forfettario</option>
                            <option value="buono-pasto">Buono Pasto</option>
                            <option value="straordinario-emergente">Straordinario Emergente</option>
                            <option value="straordinario-programmato">Straordinario Programmato</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Importo (€)</label>
                        <input type="number" id="allowance-amount" class="w-full p-2 border border-gray-300 rounded" step="0.01" min="0" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Note</label>
                        <textarea id="allowance-notes" class="w-full p-2 border border-gray-300 rounded" rows="3"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('allowance-modal')" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded hover:bg-gray-300">
                        Annulla
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded hover:bg-green-700">
                        Salva
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Absence Modal -->
    <div id="absence-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold">Aggiungi Assenza</h3>
                <button onclick="closeModal('absence-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form onsubmit="saveAbsence(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data Inizio</label>
                        <input type="date" id="absence-start" class="w-full p-2 border border-gray-300 rounded" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data Fine</label>
                        <input type="date" id="absence-end" class="w-full p-2 border border-gray-300 rounded" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo Assenza</label>
                        <select id="absence-type" class="w-full p-2 border border-gray-300 rounded" required>
                            <option value="">Seleziona...</option>
                            <option value="congedo-ordinario">Congedo Ordinario</option>
                            <option value="congedo-straordinario-malattia">Congedo Straordinario per Malattia</option>
                            <option value="congedo-straordinario-esami">Congedo Straordinario per Esami</option>
                            <option value="congedo-straordinario-familiari">Congedo Straordinario per Gravi Motivi Familiari</option>
                            <option value="congedo-straordinario-trasferimento">Congedo Straordinario per Trasferimento</option>
                            <option value="riposo-legge">Riposo Legge</option>
                            <option value="riposo-settimanale">Riposo Settimanale</option>
                            <option value="riposo-festivo">Riposo Festivo</option>
                            <option value="riposo-compensativo">Riposo Compensativo</option>
                            <option value="aspettativa">Aspettativa</option>
                            <option value="legge-104">Legge 104</option>
                            <option value="donazione-sangue">Donazione Sangue</option>
                            <option value="ore-studio">Ore di Studio</option>
                            <option value="permesso-breve">Permesso Breve</option>
                            <option value="permesso-sindacale">Permesso Sindacale</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Note</label>
                        <textarea id="absence-notes" class="w-full p-2 border border-gray-300 rounded" rows="3"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('absence-modal')" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded hover:bg-gray-300">
                        Annulla
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-orange-600 rounded hover:bg-orange-700">
                        Salva
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // PWA Variables
        let deferredPrompt;
        let isOnline = navigator.onLine;
        
        // Global Variables
        let currentUser = null;
        let currentDate = new Date();
        let shifts = JSON.parse(localStorage.getItem('shifts') || '[]');
        let allowances = JSON.parse(localStorage.getItem('allowances') || '[]');
        let absences = JSON.parse(localStorage.getItem('absences') || '[]');
        let monthlyChart = null;

        // PWA Service Worker Registration and Manifest
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Create and inject manifest
                const manifest = {
                    name: 'TurniService - Gestione Turni Forze dell\'Ordine',
                    short_name: 'TurniService',
                    description: 'Applicazione per la gestione dei turni e delle indennità delle Forze dell\'Ordine',
                    start_url: './',
                    display: 'standalone',
                    theme_color: '#1e40af',
                    background_color: '#f3f4f6',
                    orientation: 'portrait',
                    categories: ['productivity', 'business'],
                    icons: [
                        {
                            src: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="#1e40af"><circle cx="256" cy="256" r="256" fill="#1e40af"/><path d="M256 100l50 25v150l-50 25-50-25V125l50-25z" fill="white"/></svg>'),
                            sizes: '512x512',
                            type: 'image/svg+xml'
                        },
                        {
                            src: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192" fill="#1e40af"><circle cx="96" cy="96" r="96" fill="#1e40af"/><path d="M96 40l24 12v75l-24 12-24-12V52l24-12z" fill="white"/></svg>'),
                            sizes: '192x192',
                            type: 'image/svg+xml'
                        }
                    ]
                };
                
                const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
                const manifestURL = URL.createObjectURL(manifestBlob);
                const link = document.createElement('link');
                link.rel = 'manifest';
                link.href = manifestURL;
                document.head.appendChild(link);

                // Service Worker
                const swScript = `
                    const CACHE_NAME = 'turniservice-v2';
                    const urlsToCache = [
                        './',
                        'https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css',
                        'https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css',
                        'https://cdn.jsdelivr.net/npm/chart.js'
                    ];

                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                        );
                    });

                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                })
                                .catch(() => {
                                    return caches.match('./');
                                })
                        );
                    });

                    self.addEventListener('sync', event => {
                        if (event.tag === 'background-sync') {
                            event.waitUntil(doBackgroundSync());
                        }
                    });

                    function doBackgroundSync() {
                        return Promise.resolve();
                    }
                `;

                const blob = new Blob([swScript], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);

                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // PWA Install Prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-button').classList.remove('hidden');
        });

        document.getElementById('install-button').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                    document.getElementById('install-button').classList.add('hidden');
                }
                deferredPrompt = null;
            }
        });

        // Online/Offline Detection
        window.addEventListener('online', () => {
            isOnline = true;
            updateConnectionStatus();
            document.getElementById('offline-indicator').classList.remove('show');
            syncOfflineData();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            updateConnectionStatus();
            document.getElementById('offline-indicator').classList.add('show');
        });

        function updateConnectionStatus() {
            const statusElements = document.querySelectorAll('#connection-status, #connection-status-nav');
            statusElements.forEach(element => {
                if (isOnline) {
                    element.className = element.id === 'connection-status' 
                        ? 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800'
                        : 'text-xs bg-green-600 px-2 py-1 rounded';
                    element.innerHTML = '<i class="fas fa-wifi mr-1"></i>Online';
                } else {
                    element.className = element.id === 'connection-status'
                        ? 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800'
                        : 'text-xs bg-red-600 px-2 py-1 rounded';
                    element.innerHTML = '<i class="fas fa-wifi-slash mr-1"></i>Offline';
                }
            });
        }

        function syncOfflineData() {
            if (isOnline && 'serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
                navigator.serviceWorker.ready.then(registration => {
                    return registration.sync.register('background-sync');
                });
            }
        }

        // Authentication Variables
        let registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
        let currentLoginEmail = '';
        let generatedOTP = '';

        // Registration
        function handleRegistration(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const email = formData.get('email');
            
            // Check if user already exists
            if (registeredUsers[email]) {
                alert('Utente già registrato con questa email. Usa il login.');
                switchToLogin();
                return;
            }

            const userData = {
                nome: formData.get('nome'),
                cognome: formData.get('cognome'),
                email: email,
                forza: formData.get('forza'),
                grado: formData.get('grado'),
                irpef: 23,
                turnazione: 'quinta',
                registeredAt: new Date().toISOString()
            };

            // Save user
            registeredUsers[email] = userData;
            localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
            
            // Show success message and switch to login
            alert('Registrazione completata con successo! Ora puoi effettuare il login.');
            switchToLogin();
            document.getElementById('login-email').value = email;
        }

        // Login
        function handleLogin(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const email = formData.get('email');
            
            // Check if user exists
            if (!registeredUsers[email]) {
                alert('Email non trovata. Effettua prima la registrazione.');
                switchToRegistration();
                return;
            }

            // Generate OTP
            currentLoginEmail = email;
            generatedOTP = '123456'; // Demo OTP - in produzione sarebbe casuale
            
            // Simulate sending email
            setTimeout(() => {
                showOTPForm(email);
            }, 1000);
        }

        // OTP Verification
        function handleOTPVerification(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const enteredOTP = formData.get('otp');
            
            if (enteredOTP === generatedOTP) {
                // Load user data
                currentUser = registeredUsers[currentLoginEmail];
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showMainApp();
            } else {
                alert('Codice di verifica non valido. Riprova.');
                document.getElementById('otp-code').value = '';
                document.getElementById('otp-code').focus();
            }
        }

        // Form switching functions
        function switchToLogin() {
            document.getElementById('registration-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('otp-form').classList.add('hidden');
        }

        function switchToRegistration() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('registration-form').classList.remove('hidden');
            document.getElementById('otp-form').classList.add('hidden');
        }

        function showOTPForm(email) {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('otp-form').classList.remove('hidden');
            document.getElementById('otp-email').textContent = email;
            document.getElementById('otp-code').focus();
        }

        function backToLogin() {
            document.getElementById('otp-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            currentLoginEmail = '';
            generatedOTP = '';
        }

        function resendOTP() {
            generatedOTP = '123456'; // Demo OTP
            alert('Nuovo codice inviato a ' + currentLoginEmail);
            document.getElementById('otp-code').value = '';
            document.getElementById('otp-code').focus();
        }

        // Initialize authentication
        function initAuth() {
            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
                return;
            }

            // Check if there are registered users to determine default form
            const hasRegisteredUsers = Object.keys(registeredUsers).length > 0;
            if (hasRegisteredUsers) {
                switchToLogin();
            } else {
                switchToRegistration();
            }
        }

        function showMainApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('user-info').textContent = `${currentUser.nome} ${currentUser.cognome} - ${currentUser.grado}`;
            
            // Force close all modals and clean interface
            closeAllModals();
            cleanInterface();
            
            updateDashboard();
            generateCalendar();
            updateAgenda();
            updateAbsencesSummary();
            initChart();
        }

        // Clean interface from stuck elements
        function cleanInterface() {
            // Remove any floating buttons or elements that shouldn't be there
            const stuckElements = document.querySelectorAll('button[style*="position: fixed"], .floating-button, .stuck-button');
            stuckElements.forEach(el => el.remove());
            
            // Ensure all modals are properly closed
            document.querySelectorAll('.fixed.inset-0').forEach(modal => {
                if (modal.id && modal.id.includes('modal')) {
                    modal.classList.add('hidden');
                }
            });
        }

        function logout() {
            localStorage.removeItem('currentUser');
            location.reload();
        }

        // Tab Management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            event.target.classList.add('border-blue-500', 'text-blue-600');
            event.target.classList.remove('border-transparent', 'text-gray-500');
        }

        // Modal Management
        function showProfile() {
            document.getElementById('profile-forza').value = getForceLabel(currentUser.forza);
            document.getElementById('profile-grado').value = currentUser.grado;
            document.getElementById('profile-irpef').value = currentUser.irpef || 23;
            document.getElementById('profile-turnazione').value = currentUser.turnazione || 'quinta';
            document.getElementById('profile-modal').classList.remove('hidden');
        }

        function addShift() {
            document.getElementById('shift-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('shift-modal').classList.remove('hidden');
        }

        function addAllowance() {
            document.getElementById('allowance-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('allowance-modal').classList.remove('hidden');
        }

        function addAbsence() {
            document.getElementById('absence-start').value = new Date().toISOString().split('T')[0];
            document.getElementById('absence-end').value = new Date().toISOString().split('T')[0];
            document.getElementById('absence-modal').classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Data Management
        function saveShift(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const shift = {
                id: Date.now(),
                date: formData.get('shift-date') || document.getElementById('shift-date').value,
                type: formData.get('shift-type') || document.getElementById('shift-type').value,
                notes: formData.get('shift-notes') || document.getElementById('shift-notes').value,
                synced: isOnline
            };
            shifts.push(shift);
            localStorage.setItem('shifts', JSON.stringify(shifts));
            closeModal('shift-modal');
            updateDashboard();
            generateCalendar();
            updateAgenda();
            event.target.reset();
            
            if (!isOnline) {
                showOfflineNotification('Turno salvato offline');
            }
        }

        function saveAllowance(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const allowance = {
                id: Date.now(),
                date: formData.get('allowance-date') || document.getElementById('allowance-date').value,
                type: formData.get('allowance-type') || document.getElementById('allowance-type').value,
                amount: parseFloat(formData.get('allowance-amount') || document.getElementById('allowance-amount').value),
                notes: formData.get('allowance-notes') || document.getElementById('allowance-notes').value,
                synced: isOnline
            };
            allowances.push(allowance);
            localStorage.setItem('allowances', JSON.stringify(allowances));
            closeModal('allowance-modal');
            updateDashboard();
            updateChart();
            event.target.reset();
            
            if (!isOnline) {
                showOfflineNotification('Indennità salvata offline');
            }
        }

        function saveAbsence(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const absence = {
                id: Date.now(),
                startDate: formData.get('absence-start') || document.getElementById('absence-start').value,
                endDate: formData.get('absence-end') || document.getElementById('absence-end').value,
                type: formData.get('absence-type') || document.getElementById('absence-type').value,
                notes: formData.get('absence-notes') || document.getElementById('absence-notes').value,
                synced: isOnline
            };
            absences.push(absence);
            localStorage.setItem('absences', JSON.stringify(absences));
            closeModal('absence-modal');
            updateAbsencesSummary();
            event.target.reset();
            
            if (!isOnline) {
                showOfflineNotification('Assenza salvata offline');
            }
        }

        function updateProfile(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            currentUser.grado = formData.get('profile-grado') || document.getElementById('profile-grado').value;
            currentUser.irpef = parseFloat(formData.get('profile-irpef') || document.getElementById('profile-irpef').value);
            currentUser.turnazione = formData.get('profile-turnazione') || document.getElementById('profile-turnazione').value;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            document.getElementById('user-info').textContent = `${currentUser.nome} ${currentUser.cognome} - ${currentUser.grado}`;
            closeModal('profile-modal');
        }

        function showOfflineNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-16 right-4 bg-yellow-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.innerHTML = `<i class="fas fa-info-circle mr-2"></i>${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Dashboard Updates
        function updateDashboard() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const monthlyTotal = allowances
                .filter(a => {
                    const date = new Date(a.date);
                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                })
                .reduce((sum, a) => sum + a.amount, 0);
            
            document.getElementById('monthly-total').textContent = `€${monthlyTotal.toFixed(2)}`;
            
            const overtimeHours = allowances
                .filter(a => {
                    const date = new Date(a.date);
                    return (a.type === 'straordinario-emergente' || a.type === 'straordinario-programmato') &&
                           date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                })
                .length;
            
            document.getElementById('overtime-hours').textContent = overtimeHours;
            
            const leaveDays = absences
                .filter(a => a.type.includes('congedo'))
                .reduce((sum, a) => {
                    const start = new Date(a.startDate);
                    const end = new Date(a.endDate);
                    const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                    return sum + days;
                }, 0);
            
            document.getElementById('leave-days').textContent = leaveDays;
            
            const shiftsCount = shifts
                .filter(s => {
                    const date = new Date(s.date);
                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                })
                .length;
            
            document.getElementById('shifts-count').textContent = shiftsCount;
        }

        // Calendar Management
        function generateCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('calendar-title').textContent = 
                new Intl.DateTimeFormat('it-IT', { month: 'long', year: 'numeric' }).format(currentDate);
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            
            const dayHeaders = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'p-2 text-center font-semibold text-gray-700 bg-gray-100';
                header.textContent = day;
                calendarGrid.appendChild(header);
            });
            
            for (let i = 0; i < 42; i++) {
                const currentDay = new Date(startDate);
                currentDay.setDate(startDate.getDate() + i);
                
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day p-2 text-sm';
                
                if (currentDay.getMonth() !== month) {
                    dayDiv.classList.add('text-gray-400');
                }
                
                if (currentDay.toDateString() === new Date().toDateString()) {
                    dayDiv.classList.add('today');
                }
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'font-semibold mb-1';
                dayNumber.textContent = currentDay.getDate();
                dayDiv.appendChild(dayNumber);
                
                const dayShifts = shifts.filter(s => s.date === formatDate(currentDay));
                const dayAllowances = allowances.filter(a => a.date === formatDate(currentDay));
                
                dayShifts.forEach(shift => {
                    const shiftDiv = document.createElement('div');
                    shiftDiv.className = `shift-${shift.type} text-xs p-1 rounded mb-1`;
                    shiftDiv.textContent = shift.type.charAt(0).toUpperCase() + shift.type.slice(1);
                    if (!shift.synced && !isOnline) {
                        shiftDiv.innerHTML += ' <i class="fas fa-cloud-upload-alt text-gray-500"></i>';
                    }
                    dayDiv.appendChild(shiftDiv);
                });
                
                if (dayAllowances.length > 0) {
                    const totalAmount = dayAllowances.reduce((sum, a) => sum + a.amount, 0);
                    const allowanceDiv = document.createElement('div');
                    allowanceDiv.className = 'text-xs text-green-600 font-semibold';
                    allowanceDiv.textContent = `€${totalAmount.toFixed(2)}`;
                    dayDiv.appendChild(allowanceDiv);
                }
                
                calendarGrid.appendChild(dayDiv);
            }
            
            if (currentUser.turnazione === 'quinta') {
                generateQuintaShifts();
            }
        }

        function generateQuintaShifts() {
            const startOfYear = new Date(currentDate.getFullYear(), 0, 1);
            const shiftPattern = ['sera', 'pomeriggio', 'mattina', 'notte', 'riposo'];
            let currentShiftIndex = 0;
            
            shifts = shifts.filter(s => new Date(s.date).getFullYear() !== currentDate.getFullYear());
            
            for (let d = new Date(startOfYear); d.getFullYear() === currentDate.getFullYear(); d.setDate(d.getDate() + 1)) {
                const existingShift = shifts.find(s => s.date === formatDate(d));
                if (!existingShift) {
                    shifts.push({
                        id: Date.now() + Math.random(),
                        date: formatDate(d),
                        type: shiftPattern[currentShiftIndex],
                        notes: `Turno automatico ${shiftPattern[currentShiftIndex]}`,
                        synced: isOnline
                    });
                }
                currentShiftIndex = (currentShiftIndex + 1) % 5;
            }
            
            localStorage.setItem('shifts', JSON.stringify(shifts));
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar();
        }

        // Agenda Management
        function updateAgenda() {
            const agendaList = document.getElementById('agenda-list');
            agendaList.innerHTML = '';
            
            const today = new Date();
            const nextMonth = new Date(today);
            nextMonth.setDate(today.getDate() + 30);
            
            const upcomingShifts = shifts
                .filter(s => {
                    const shiftDate = new Date(s.date);
                    return shiftDate >= today && shiftDate <= nextMonth;
                })
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            upcomingShifts.forEach(shift => {
                const item = document.createElement('div');
                item.className = 'border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow';
                
                const shiftDate = new Date(shift.date);
                const dayAllowances = allowances.filter(a => a.date === shift.date);
                const totalAllowances = dayAllowances.reduce((sum, a) => sum + a.amount, 0);
                
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-lg">${formatDateLong(shiftDate)}</h4>
                            <p class="text-gray-600 shift-${shift.type}">${shift.type.charAt(0).toUpperCase() + shift.type.slice(1)}</p>
                            ${shift.notes ? `<p class="text-sm text-gray-500 mt-1">${shift.notes}</p>` : ''}
                            ${!shift.synced && !isOnline ? '<p class="text-xs text-yellow-600 mt-1"><i class="fas fa-cloud-upload-alt mr-1"></i>Non sincronizzato</p>' : ''}
                        </div>
                        <div class="text-right">
                            ${totalAllowances > 0 ? `<p class="text-green-600 font-semibold">€${totalAllowances.toFixed(2)}</p>` : ''}
                            <p class="text-xs text-gray-400">${dayAllowances.length} indennità</p>
                        </div>
                    </div>
                `;
                
                agendaList.appendChild(item);
            });
            
            if (upcomingShifts.length === 0) {
                agendaList.innerHTML = '<p class="text-center text-gray-500 py-8">Nessun turno programmato nei prossimi 30 giorni.</p>';
            }
        }

        // Absences Management
        function updateAbsencesSummary() {
            const currentYear = new Date().getFullYear();
            
            const congeديOrdinari = absences.filter(a => a.type === 'congedo-ordinario' && new Date(a.startDate).getFullYear() === currentYear).length;
            const congeديStraordinari = absences.filter(a => a.type.includes('congedo-straordinario') && new Date(a.startDate).getFullYear() === currentYear).length;
            const permessiBrevi = absences.filter(a => a.type === 'permesso-breve' && new Date(a.startDate).getFullYear() === currentYear).length;
            const riposiLegge = absences.filter(a => a.type === 'riposo-legge' && new Date(a.startDate).getFullYear() === currentYear).length;
            
            document.getElementById('congedi-ordinari').textContent = congeديOrdinari;
            document.getElementById('congedi-straordinari').textContent = congeديStraordinari;
            document.getElementById('permessi-brevi').textContent = permessiBrevi;
            document.getElementById('riposi-legge').textContent = riposiLegge;
            
            const absencesList = document.getElementById('absences-list');
            absencesList.innerHTML = '';
            
            const sortedAbsences = absences
                .sort((a, b) => new Date(b.startDate) - new Date(a.startDate))
                .slice(0, 10);
            
            sortedAbsences.forEach(absence => {
                const item = document.createElement('div');
                item.className = 'border border-gray-200 rounded-lg p-4';
                
                const startDate = new Date(absence.startDate);
                const endDate = new Date(absence.endDate);
                const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold">${getAbsenceTypeLabel(absence.type)}</h4>
                            <p class="text-gray-600">${formatDateLong(startDate)} - ${formatDateLong(endDate)}</p>
                            ${absence.notes ? `<p class="text-sm text-gray-500 mt-1">${absence.notes}</p>` : ''}
                            ${!absence.synced && !isOnline ? '<p class="text-xs text-yellow-600 mt-1"><i class="fas fa-cloud-upload-alt mr-1"></i>Non sincronizzato</p>' : ''}
                        </div>
                        <div class="text-right">
                            <p class="font-semibold">${duration} giorn${duration === 1 ? 'o' : 'i'}</p>
                        </div>
                    </div>
                `;
                
                absencesList.appendChild(item);
            });
        }

        // Search Functionality
        function performSearch() {
            const type = document.getElementById('search-type').value;
            const fromDate = document.getElementById('search-from').value;
            const toDate = document.getElementById('search-to').value;
            
            const results = [];
            
            if (!type || type === 'shift') {
                const filteredShifts = shifts.filter(s => {
                    const date = new Date(s.date);
                    const from = fromDate ? new Date(fromDate) : new Date('1900-01-01');
                    const to = toDate ? new Date(toDate) : new Date('2100-12-31');
                    return date >= from && date <= to;
                });
                
                filteredShifts.forEach(shift => {
                    results.push({
                        type: 'shift',
                        data: shift,
                        date: shift.date
                    });
                });
            }
            
            if (!type || type === 'absence') {
                const filteredAbsences = absences.filter(a => {
                    const date = new Date(a.startDate);
                    const from = fromDate ? new Date(fromDate) : new Date('1900-01-01');
                    const to = toDate ? new Date(toDate) : new Date('2100-12-31');
                    return date >= from && date <= to;
                });
                
                filteredAbsences.forEach(absence => {
                    results.push({
                        type: 'absence',
                        data: absence,
                        date: absence.startDate
                    });
                });
            }
            
            if (!type || type === 'allowance') {
                const filteredAllowances = allowances.filter(a => {
                    const date = new Date(a.date);
                    const from = fromDate ? new Date(fromDate) : new Date('1900-01-01');
                    const to = toDate ? new Date(toDate) : new Date('2100-12-31');
                    return date >= from && date <= to;
                });
                
                filteredAllowances.forEach(allowance => {
                    results.push({
                        type: 'allowance',
                        data: allowance,
                        date: allowance.date
                    });
                });
            }
            
            results.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const searchResults = document.getElementById('search-results');
            searchResults.innerHTML = '';
            
            if (results.length === 0) {
                searchResults.innerHTML = '<p class="text-center text-gray-500 py-8">Nessun risultato trovato.</p>';
                return;
            }
            
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'border border-gray-200 rounded-lg p-4';
                
                let content = '';
                const date = new Date(result.date);
                
                switch (result.type) {
                    case 'shift':
                        content = `
                            <div class="flex items-center mb-2">
                                <i class="fas fa-clock text-blue-500 mr-2"></i>
                                <span class="font-semibold">Turno</span>
                                ${!result.data.synced && !isOnline ? '<i class="fas fa-cloud-upload-alt text-yellow-500 ml-2" title="Non sincronizzato"></i>' : ''}
                            </div>
                            <p class="text-gray-600">${formatDateLong(date)} - ${result.data.type}</p>
                            ${result.data.notes ? `<p class="text-sm text-gray-500 mt-1">${result.data.notes}</p>` : ''}
                        `;
                        break;
                    case 'absence':
                        const endDate = new Date(result.data.endDate);
                        const duration = Math.ceil((endDate - date) / (1000 * 60 * 60 * 24)) + 1;
                        content = `
                            <div class="flex items-center mb-2">
                                <i class="fas fa-calendar-times text-orange-500 mr-2"></i>
                                <span class="font-semibold">Assenza</span>
                                ${!result.data.synced && !isOnline ? '<i class="fas fa-cloud-upload-alt text-yellow-500 ml-2" title="Non sincronizzato"></i>' : ''}
                            </div>
                            <p class="text-gray-600">${getAbsenceTypeLabel(result.data.type)}</p>
                            <p class="text-gray-600">${formatDateLong(date)} - ${formatDateLong(endDate)} (${duration} giorni)</p>
                            ${result.data.notes ? `<p class="text-sm text-gray-500 mt-1">${result.data.notes}</p>` : ''}
                        `;
                        break;
                    case 'allowance':
                        content = `
                            <div class="flex items-center mb-2">
                                <i class="fas fa-euro-sign text-green-500 mr-2"></i>
                                <span class="font-semibold">Indennità</span>
                                ${!result.data.synced && !isOnline ? '<i class="fas fa-cloud-upload-alt text-yellow-500 ml-2" title="Non sincronizzato"></i>' : ''}
                            </div>
                            <p class="text-gray-600">${getAllowanceTypeLabel(result.data.type)} - €${result.data.amount.toFixed(2)}</p>
                            <p class="text-gray-600">${formatDateLong(date)}</p>
                            ${result.data.notes ? `<p class="text-sm text-gray-500 mt-1">${result.data.notes}</p>` : ''}
                        `;
                        break;
                }
                
                item.innerHTML = content;
                searchResults.appendChild(item);
            });
        }

        // Chart Management
        function initChart() {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            
            const monthlyData = [];
            const labels = [];
            
            for (let i = 11; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                
                const monthAllowances = allowances.filter(a => {
                    const allowanceDate = new Date(a.date);
                    return allowanceDate.getMonth() === date.getMonth() && 
                           allowanceDate.getFullYear() === date.getFullYear();
                });
                
                const total = monthAllowances.reduce((sum, a) => sum + a.amount, 0);
                
                monthlyData.push(total);
                labels.push(new Intl.DateTimeFormat('it-IT', { month: 'short', year: '2-digit' }).format(date));
            }
            
            monthlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Indennità Mensili (€)',
                        data: monthlyData,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '€' + value.toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        function updateChart() {
            if (monthlyChart) {
                const monthlyData = [];
                
                for (let i = 11; i >= 0; i--) {
                    const date = new Date();
                    date.setMonth(date.getMonth() - i);
                    
                    const monthAllowances = allowances.filter(a => {
                        const allowanceDate = new Date(a.date);
                        return allowanceDate.getMonth() === date.getMonth() && 
                               allowanceDate.getFullYear() === date.getFullYear();
                    });
                    
                    const total = monthAllowances.reduce((sum, a) => sum + a.amount, 0);
                    monthlyData.push(total);
                }
                
                monthlyChart.data.datasets[0].data = monthlyData;
                monthlyChart.update();
            }
        }

        // Backup Functionality
        function backupData() {
            const backup = {
                user: currentUser,
                shifts: shifts,
                allowances: allowances,
                absences: absences,
                timestamp: new Date().toISOString(),
                version: '2.0'
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `turniservice_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // Utility Functions
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function formatDateLong(date) {
            return new Intl.DateTimeFormat('it-IT', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            }).format(date);
        }

        function getForceLabel(forceCode) {
            const forces = {
                'carabinieri': 'Carabinieri',
                'guardia-finanza': 'Guardia di Finanza',
                'polizia-stato': 'Polizia di Stato',
                'polizia-penitenziaria': 'Polizia Penitenziaria'
            };
            return forces[forceCode] || forceCode;
        }

        function getAbsenceTypeLabel(type) {
            const types = {
                'congedo-ordinario': 'Congedo Ordinario',
                'congedo-straordinario-malattia': 'Congedo Straordinario per Malattia',
                'congedo-straordinario-esami': 'Congedo Straordinario per Esami',
                'congedo-straordinario-familiari': 'Congedo Straordinario per Gravi Motivi Familiari',
                'congedo-straordinario-trasferimento': 'Congedo Straordinario per Trasferimento',
                'riposo-legge': 'Riposo Legge',
                'riposo-settimanale': 'Riposo Settimanale',
                'riposo-festivo': 'Riposo Festivo',
                'riposo-compensativo': 'Riposo Compensativo',
                'aspettativa': 'Aspettativa',
                'legge-104': 'Legge 104',
                'donazione-sangue': 'Donazione Sangue',
                'ore-studio': 'Ore di Studio',
                'permesso-breve': 'Permesso Breve',
                'permesso-sindacale': 'Permesso Sindacale'
            };
            return types[type] || type;
        }

        function getAllowanceTypeLabel(type) {
            const types = {
                'ordine-pubblico': 'Ordine Pubblico',
                'servizio-esterno': 'Servizio Esterno',
                'cambio-turno': 'Cambio Turno',
                'missione': 'Missione',
                'reperibilita': 'Reperibilità',
                'rimborso-forfettario': 'Rimborso Forfettario',
                'buono-pasto': 'Buono Pasto',
                'straordinario-emergente': 'Straordinario Emergente',
                'straordinario-programmato': 'Straordinario Programmato'
            };
            return types[type] || type;
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            updateConnectionStatus();
            
            // Close any open modals on page load
            document.querySelectorAll('[id$="-modal"]').forEach(modal => {
                modal.classList.add('hidden');
            });
            
            // Initialize authentication system
            initAuth();
        });

        // Force close all modals function
        function closeAllModals() {
            document.querySelectorAll('[id$="-modal"]').forEach(modal => {
                modal.classList.add('hidden');
            });
        }

        // Close modals on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeAllModals();
            }
        });

        // PWA Update Notification
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                window.location.reload();
            });
        }

        // Handle app shortcuts (when installed as PWA)
        if ('navigator' in window && 'serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data && event.data.type === 'SKIP_WAITING') {
                    window.location.reload();
                }
            });
        }
    </script>
</body>
</html><!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TurniService - Gestione Turni Forze dell'Ordine</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Applicazione per la gestione dei turni e delle indennità delle Forze dell'Ordine">
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TurniService">
    
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .calendar-day {
            min-height: 120px;
            border: 1px solid #e5e7eb;
        }
        .calendar-day.today {
            background-color: #eff6ff;
            border-color: #3b82f6;
        }
        .shift-sera { background-color: #fef3c7; }
        .shift-pomeriggio { background-color: #d1fae5; }
        .shift-mattina { background-color: #dbeafe; }
        .shift-notte { background-color: #e0e7ff; }
        .shift-riposo { background-color: #f3f4f6; }
        .hidden { display: none; }
        
        /* PWA Install Button */
        .install-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 24px;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .install-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.4);
        }
        
        .install-button.hidden {
            display: none;
        }
        
        /* Offline indicator */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #f59e0b;
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 14px;
            z-index: 9999;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        
        .offline-indicator.show {
            transform: translateY(0);
        }
        
        /* Loading spinner for offline sync */
        .sync-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Fix for action buttons visibility */
        .quick-actions button {
            min-height: 100px;
            color: white !important;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .quick-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Offline Indicator -->
    <div id="offline-indicator" class="offline-indicator">
        <i class="fas fa-wifi mr-2"></i>
        Modalità offline attiva - I dati verranno sincronizzati quando tornerai online
    </div>

    <!-- PWA Install Button -->
    <button id="install-button" class="install-button hidden">
        <i class="fas fa-download mr-2"></i>
        Installa App
    </button>

    <!-- Login/Registration Screen -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <div class="mx-auto h-20 w-20 bg-blue-600 rounded-full flex items-center justify-center">
                    <i class="fas fa-shield-alt text-white text-2xl"></i>
                </div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    TurniService
                </h2>
                <p class="mt-2 text-center text-sm text-gray-600">
                    Gestione Turni Forze dell'Ordine
                </p>
                <div class="mt-2 text-center">
                    <span id="connection-status" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <i class="fas fa-wifi mr-1"></i>Online
                    </span>
                </div>
            </div>

            <!-- Registration Form -->
            <form id="registration-form" class="mt-8 space-y-6" onsubmit="handleRegistration(event)">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <input id="reg-nome" name="nome" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Nome">
                    </div>
                    <div>
                        <input id="reg-cognome" name="cognome" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Cognome">
                    </div>
                    <div>
                        <input id="reg-email" name="email" type="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Email istituzionale">
                    </div>
                    <div>
                        <select id="reg-forza" name="forza" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm">
                            <option value="">Seleziona Forza di Appartenenza</option>
                            <optgroup label="Forze Armate">
                                <option value="carabinieri">Carabinieri</option>
                                <option value="guardia-finanza">Guardia di Finanza</option>
                            </optgroup>
                            <optgroup label="Forze dell'Ordine">
                                <option value="polizia-stato">Polizia di Stato</option>
                                <option value="polizia-penitenziaria">Polizia Penitenziaria</option>
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <input id="reg-grado" name="grado" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Grado">
                    </div>
                </div>

                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <i class="fas fa-user-plus mr-2"></i>
                        Registrati
                    </button>
                </div>
                <div class="text-center">
                    <button type="button" onclick="switchToLogin()" class="text-indigo-600 hover:text-indigo-500 text-sm">
                        Hai già un account? Accedi
                    </button>
                </div>
            </form>

            <!-- Login Form -->
            <form id="login-form" class="mt-8 space-y-6 hidden" onsubmit="handleLogin(event)">
                <div class="rounded-md shadow-sm">
                    <div>
                        <input id="login-email" name="email" type="email" required class="appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Email istituzionale">
                    </div>
                </div>

                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <i class="fas fa-paper-plane mr-2"></i>
                        Invia Codice di Verifica
                    </button>
                </div>
                <div class="text-center">
                    <button type="button" onclick="switchToRegistration()" class="text-indigo-600 hover:text-indigo-500 text-sm">
                        Non hai un account? Registrati
                    </button>
                </div>
            </form>

            <!-- OTP Verification Form -->
            <form id="otp-form" class="mt-8 space-y-6 hidden" onsubmit="handleOTPVerification(event)">
                <div class="text-center mb-4">
                    <i class="fas fa-envelope text-4xl text-indigo-600 mb-2"></i>
                    <h3 class="text-lg font-medium text-gray-900">Codice inviato!</h3>
                    <p class="text-sm text-gray-600">Abbiamo inviato un codice di verifica a:</p>
                    <p id="otp-email" class="text-sm font-medium text-indigo-600"></p>
                </div>
                
                <div class="rounded-md shadow-sm">
                    <div>
                        <input id="otp-code" name="otp" type="text" maxlength="6" required class="appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm text-center text-2xl tracking-widest" placeholder="123456">
                    </div>
                </div>

                <div class="bg-blue-50 p-4 rounded-md">
                    <div class="flex items-center">
                        <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                        <p class="text-sm text-blue-700">
                            <strong>Demo:</strong> Usa il codice <span class="font-mono font-bold">123456</span> per accedere
                        </p>
                    </div>
                </div>

                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        Verifica e Accedi
                    </button>
                </div>
                
                <div class="text-center space-y-2">
                    <button type="button" onclick="resendOTP()" class="text-indigo-600 hover:text-indigo-500 text-sm">
                        <i class="fas fa-redo mr-1"></i>
                        Invia nuovamente il codice
                    </button>
                    <br>
                    <button type="button" onclick="backToLogin()" class="text-gray-500 hover:text-gray-700 text-sm">
                        <i class="fas fa-arrow-left mr-1"></i>
                        Torna al login
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="hidden">
        <!-- Navigation -->
        <nav class="bg-blue-800 text-white p-4">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-shield-alt text-2xl"></i>
                    <h1 class="text-xl font-bold">TurniService</h1>
                    <span id="sync-status" class="hidden">
                        <div class="sync-spinner"></div>
                    </span>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="user-info"></span>
                    <span id="connection-status-nav" class="text-xs bg-green-600 px-2 py-1 rounded">Online</span>
                    <button onclick="showProfile()" class="bg-blue-700 px-3 py-1 rounded hover:bg-blue-600">
                        <i class="fas fa-user"></i> Profilo
                    </button>
                    <button onclick="logout()" class="bg-red-600 px-3 py-1 rounded hover:bg-red-500">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Tab Navigation -->
        <div class="bg-white shadow-sm border-b border-gray-200">
            <div class="container mx-auto">
                <nav class="flex space-x-8">
                    <button onclick="showTab('dashboard')" class="tab-btn py-4 px-1 border-b-2 border-blue-500 text-blue-600 font-medium text-sm">
                        <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                    </button>
                    <button onclick="showTab('calendar')" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm">
                        <i class="fas fa-calendar mr-2"></i>Calendario
                    </button>
                    <button onclick="showTab('agenda')" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm">
                        <i class="fas fa-list mr-2"></i>Agenda
                    </button>
                    <button onclick="showTab('absences')" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm">
                        <i class="fas fa-calendar-times mr-2"></i>Assenze
                    </button>
                    <button onclick="showTab('search')" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm">
                        <i class="fas fa-search mr-2"></i>Ricerca
                    </button>
                </nav>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content container mx-auto p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 text-green-500">
                            <i class="fas fa-euro-sign text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Indennità Mese</p>
                            <p id="monthly-total" class="text-2xl font-semibold text-gray-900">€0,00</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-500">
                            <i class="fas fa-clock text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Ore Straordinario</p>
                            <p id="overtime-hours" class="text-2xl font-semibold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-orange-100 text-orange-500">
                            <i class="fas fa-calendar-alt text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Giorni Congedo</p>
                            <p id="leave-days" class="text-2xl font-semibold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-100 text-purple-500">
                            <i class="fas fa-user-clock text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Turni Mese</p>
                            <p id="shifts-count" class="text-2xl font-semibold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <h3 class="text-lg font-semibold mb-4">Azioni Rapide</h3>
                <div class="space-y-4">
                    <!-- Prima riga -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button onclick="addShift()" class="bg-blue-500 text-white p-6 rounded-lg hover:bg-blue-600 text-center transition-all duration-200 min-h-[100px] flex flex-col items-center justify-center shadow-lg">
                            <i class="fas fa-plus-circle text-3xl mb-2"></i>
                            <p class="font-semibold text-lg">Aggiungi Turno</p>
                        </button>
                        <button onclick="addAllowance()" class="bg-green-500 text-white p-6 rounded-lg hover:bg-green-600 text-center transition-all duration-200 min-h-[100px] flex flex-col items-center justify-center shadow-lg">
                            <i class="fas fa-euro-sign text-3xl mb-2"></i>
                            <p class="font-semibold text-lg">Indennità</p>
                        </button>
                    </div>
                    <!-- Seconda riga -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button onclick="addAbsence()" class="bg-orange-500 text-white p-6 rounded-lg hover:bg-orange-600 text-center transition-all duration-200 min-h-[100px] flex flex-col items-center justify-center shadow-lg">
                            <i class="fas fa-calendar-times text-3xl mb-2"></i>
                            <p class="font-semibold text-lg">Assenza</p>
                        </button>
                        <button onclick="backupData()" class="bg-purple-500 text-white p-6 rounded-lg hover:bg-purple-600 text-center transition-all duration-200 min-h-[100px] flex flex-col items-center justify-center shadow-lg">
                            <i class="fas fa-download text-3xl mb-2"></i>
                            <p class="font-semibold text-lg">Backup</p>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Monthly Chart -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">Andamento Indennità Mensili</h3>
                <div style="height: 400px;">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Calendar Tab -->
        <div id="calendar-tab" class="tab-content hidden container mx-auto p-6">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold" id="calendar-title"></h2>
                    <div class="flex space-x-2">
                        <button onclick="previousMonth()" class="bg-gray-200 p-2 rounded hover:bg-gray-300">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button onclick="nextMonth()" class="bg-gray-200 p-2 rounded hover:bg-gray-300">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Legend -->
                <div class="flex flex-wrap gap-4 mb-4">
                    <div class="flex items-center">
                        <div class="w-4 h-4 shift-sera mr-2"></div>
                        <span class="text-sm">Sera</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 shift-pomeriggio mr-2"></div>
                        <span class="text-sm">Pomeriggio</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 shift-mattina mr-2"></div>
                        <span class="text-sm">Mattina</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 shift-notte mr-2"></div>
                        <span class="text-sm">Notte</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 shift-riposo mr-2"></div>
                        <span class="text-sm">Riposo</span>
                    </div>
                </div>

                <div class="grid grid-cols-7 gap-1" id="calendar-grid">
                    <!-- Calendar will be generated here -->
                </div>
            </div>
        </div>

        <!-- Agenda Tab -->
        <div id="agenda-tab" class="tab-content hidden container mx-auto p-6">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Agenda</h2>
                    <button onclick="addShift()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        <i class="fas fa-plus mr-2"></i>Aggiungi Turno
                    </button>
                </div>
                <div id="agenda-list" class="space-y-4">
                    <!-- Agenda items will be generated here -->
                </div>
            </div>
        </div>

        <!-- Absences Tab -->
        <div id="absences-tab" class="tab-content hidden container mx-auto p-6">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Gestione Assenze</h2>
                    <button onclick="addAbsence()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                        <i class="fas fa-plus mr-2"></i>Aggiungi Assenza
                    </button>
                </div>
                
                <!-- Absence Summary -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-blue-800">Congedi Ordinari</h4>
                        <p class="text-2xl font-bold text-blue-600" id="congedi-ordinari">0</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-green-800">Congedi Straordinari</h4>
                        <p class="text-2xl font-bold text-green-600" id="congedi-straordinari">0</p>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-orange-800">Permessi Brevi</h4>
                        <p class="text-2xl font-bold text-orange-600" id="permessi-brevi">0</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-purple-800">Riposi Legge</h4>
                        <p class="text-2xl font-bold text-purple-600" id="riposi-legge">0</p>
                    </div>
                </div>

                <div id="absences-list" class="space-y-4">
                    <!-- Absences will be listed here -->
                </div>
            </div>
        </div>

        <!-- Search Tab -->
        <div id="search-tab" class="tab-content hidden container mx-auto p-6">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-2xl font-bold mb-6">Ricerca</h2>
                
                <!-- Search Form -->
                <div class="mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                            <select id="search-type" class="w-full p-2 border border-gray-300 rounded">
                                <option value="">Tutti</option>
                                <option value="shift">Turni</option>
                                <option value="absence">Assenze</option>
                                <option value="allowance">Indennità</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Da</label>
                            <input type="date" id="search-from" class="w-full p-2 border border-gray-300 rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data A</label>
                            <input type="date" id="search-to" class="w-full p-2 border border-gray-300 rounded">
                        </div>
                    </div>
                    <button onclick="performSearch()" class="mt-4 bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">
                        <i class="fas fa-search mr-2"></i>Cerca
                    </button>
                </div>

                <div id="search-results" class="space-y-4">
                    <!-- Search results will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Profile Modal -->
    <div id="profile-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold">Impostazioni Profilo</h3>
                <button onclick="closeModal('profile-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form onsubmit="updateProfile(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Forza di Appartenenza</label>
                        <input type="text" id="profile-forza" class="w-full p-2 border border-gray-300 rounded" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Grado</label>
                        <input type="text" id="profile-grado" class="w-full p-2 border border-gray-300 rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Aliquota IRPEF (%)</label>
                        <input type="number" id="profile-irpef" class="w-full p-2 border border-gray-300 rounded" step="0.1" min="0" max="50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Turnazione</label>
                        <select id="profile-turnazione" class="w-full p-2 border border-gray-300 rounded">
                            <option value="quinta">Turno in Quinta</option>
                            <option value="terza">Turno in Terza</option>
                            <option value="ufficio">Orari da Ufficio</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('profile-modal')" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded hover:bg-gray-300">
                        Annulla
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700">
                        Salva
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Shift Modal -->
    <div id="shift-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold">Aggiungi Turno</h3>
                <button onclick="closeModal('shift-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form onsubmit="saveShift(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                        <input type="date" id="shift-date" class="w-full p-2 border border-gray-300 rounded" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo Turno</label>
                        <select id="shift-type" class="w-full p-2 border border-gray-300 rounded" required>
                            <option value="">Seleziona...</option>
                            <option value="sera">Sera</option>
                            <option value="pomeriggio">Pomeriggio</option>
                            <option value="mattina">Mattina</option>
                            <option value="notte">Notte</option>
                            <option value="riposo">Riposo</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Note</label>
                        <textarea id="shift-notes" class="w-full p-2 border border-gray-300 rounded" rows="3"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('shift-modal')" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded hover:bg-gray-300">
                        Annulla
