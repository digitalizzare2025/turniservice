<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>TurniService - Gestione Turni Forze dell'Ordine</title>
  <meta name="theme-color" content="#1f3fa3">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="favicon.ico">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <!-- Icone -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    body { background:#f4f6f8; }
    header.navbar { background:#223ea8; }
    header .navbar-brand, header .nav-link, header .navbar-text { color:#fff !important; }
    .page { display:none; }
    .page.active { display:block; }
    .card { border-radius: 12px; }
    .quick-action .btn { width:100%; height:64px; }
    #chart-indennita { min-height: 280px; display: block; }
    #calendario-app { min-height: 520px; }

    /* Overlay login (OTP demo) */
    #auth-overlay { position: fixed; inset: 0; background: #ffffff; z-index: 9999; overflow: auto; }

    /* Classi facoltative per i turni (non alterano palette esistente) */
    .turno-sera{}
    .turno-pomeriggio{}
    .turno-mattina{}
    .turno-notte{}
    .turno-riposo{}
  </style>
</head>
<body>

  <!-- NAVBAR -->
  <header class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <i class="bi bi-shield-lock"></i> <span>TurniService</span>
      </a>
      <div class="ms-auto d-flex align-items-center gap-2">
        <span class="badge bg-success">Online</span>
        <a class="btn btn-light btn-sm" href="#" id="btn-profile"><i class="bi bi-person-circle me-1"></i>Profilo</a>
        <button class="btn btn-danger btn-sm" id="btn-logout" title="Esci"><i class="bi bi-box-arrow-right"></i></button>
      </div>
    </div>
  </header>

  <!-- TABS -->
  <nav class="border-bottom bg-white">
    <div class="container py-2">
      <ul class="nav nav-tabs" id="mainTabs">
        <li class="nav-item"><a class="nav-link active" data-target="page-dashboard" href="#">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" data-target="page-calendario" href="#">Calendario</a></li>
        <li class="nav-item"><a class="nav-link" data-target="page-agenda" href="#">Agenda</a></li>
        <li class="nav-item"><a class="nav-link" data-target="page-assenze" href="#">Assenze</a></li>
        <li class="nav-item"><a class="nav-link" data-target="page-ricerca" href="#">Ricerca</a></li>
      </ul>
    </div>
  </nav>

  <main class="container my-4">

    <!-- DASHBOARD -->
    <section id="page-dashboard" class="page active">
      <div class="row g-3">
        <div class="col-12 col-md-3">
          <div class="card"><div class="card-body">
            <div class="d-flex align-items-center gap-3">
              <div class="display-6">€</div>
              <div>
                <div class="small text-muted">Indennità Mese</div>
                <div class="fw-bold fs-4" id="val-indennita-mese">€0,00</div>
              </div>
            </div>
          </div></div>
        </div>
        <div class="col-12 col-md-3">
          <div class="card"><div class="card-body">
            <div class="small text-muted">Ore Straordinario</div>
            <div class="fw-bold fs-4" id="val-straordinario">0</div>
          </div></div>
        </div>
        <div class="col-12 col-md-3">
          <div class="card"><div class="card-body">
            <div class="small text-muted">Giorni Congedo</div>
            <div class="fw-bold fs-4" id="val-congedo">0</div>
          </div></div>
        </div>
        <div class="col-12 col-md-3">
          <div class="card"><div class="card-body">
            <div class="small text-muted">Turni Mese</div>
            <div class="fw-bold fs-4" id="val-turni-mese">0</div>
          </div></div>
        </div>
      </div>

      <div class="card my-4">
        <div class="card-body">
          <h5 class="mb-3">Azioni Rapide</h5>
          <div class="row g-3">
            <div class="col-12 col-md-6 col-lg-3"><button class="btn btn-primary quick-action" data-bs-toggle="modal" data-bs-target="#modalAddTurno"><i class="bi bi-plus-circle me-2"></i>Aggiungi Turno</button></div>
            <div class="col-12 col-md-6 col-lg-3"><button class="btn btn-success quick-action" data-bs-toggle="modal" data-bs-target="#modalAddIndennita"><i class="bi bi-currency-euro me-2"></i>Indennità</button></div>
            <div class="col-12 col-md-6 col-lg-3"><button class="btn btn-danger quick-action" data-bs-toggle="modal" data-bs-target="#modalAddAssenza"><i class="bi bi-calendar-x me-2"></i>Assenza</button></div>
            <div class="col-12 col-md-6 col-lg-3"><button class="btn btn-secondary quick-action" id="btn-backup"><i class="bi bi-download me-2"></i>Backup</button></div>
          </div>
        </div>
      </div>

      <div class="card my-4">
        <div class="card-body">
          <h5 class="mb-3">Andamento Indennità Mensili</h5>
          <div style="height:320px">
            <canvas id="chart-indennita" role="img" aria-label="Andamento Indennità Mensili"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- CALENDARIO -->
    <section id="page-calendario" class="page">
      <div class="card">
        <div class="card-body">
          <h4 class="mb-3">Calendario</h4>
          <div class="mb-2 small">
            <span class="me-3"><span class="badge bg-light text-dark">Sera</span></span>
            <span class="me-3"><span class="badge bg-light text-dark">Pomeriggio</span></span>
            <span class="me-3"><span class="badge bg-light text-dark">Mattina</span></span>
            <span class="me-3"><span class="badge bg-light text-dark">Notte</span></span>
            <span class="me-3"><span class="badge bg-light text-dark">Riposo</span></span>
            <span class="me-3"><span class="badge bg-success">Assenze</span></span>
          </div>
          <div id="calendario-app" aria-label="Calendario turni"></div>
        </div>
      </div>
    </section>

    <!-- AGENDA -->
    <section id="page-agenda" class="page">
      <div class="card mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Agenda</h4>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAddTurno"><i class="bi bi-plus-circle me-2"></i>Aggiungi Turno</button>
          </div>
        </div>
      </div>

      <!-- Generatore turnazione in quinta -->
      <div class="card mb-3" id="turnazione-quinta">
        <div class="card-body">
          <h5 class="mb-3">Imposta Turnazione in Quinta</h5>
          <div class="row g-3 align-items-end">
            <div class="col-12 col-md-3">
              <label for="r-start" class="form-label">Data inizio</label>
              <input type="date" id="r-start" class="form-control">
            </div>
            <div class="col-12 col-md-3">
              <label for="r-end" class="form-label">Data fine</label>
              <input type="date" id="r-end" class="form-control">
            </div>
            <div class="col-12 col-md-3">
              <label for="r-start-shift" class="form-label">Turno iniziale</label>
              <select id="r-start-shift" class="form-select">
                <option value="sera">Sera</option>
                <option value="pomeriggio">Pomeriggio</option>
                <option value="mattina">Mattina</option>
                <option value="notte">Notte</option>
                <option value="riposo">Riposo</option>
              </select>
            </div>
            <div class="col-12 col-md-3">
              <button id="r-genera" class="btn btn-success w-100"><i class="bi bi-arrow-repeat me-2"></i>Genera turni</button>
            </div>
          </div>
          <p id="r-esito" class="mt-2 small text-muted" aria-live="polite"></p>
        </div>
      </div>

      <!-- Lista agenda -->
      <div class="card">
        <div class="card-body">
          <div id="agenda-list" class="vstack gap-3"></div>
        </div>
      </div>
    </section>

    <!-- ASSENZE -->
    <section id="page-assenze" class="page">
      <div class="card">
        <div class="card-body">
          <h4 class="mb-3">Gestione Assenze</h4>
          <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalAddAssenza">Aggiungi Assenza</button>
          <div class="row mt-4">
            <div class="col-6 col-md-3"><div class="border rounded p-3"><div class="small text-muted">Congedi Ordinari</div><div class="fs-4 fw-bold">0</div></div></div>
            <div class="col-6 col-md-3"><div class="border rounded p-3"><div class="small text-muted">Congedi Straordinari</div><div class="fs-4 fw-bold">0</div></div></div>
            <div class="col-6 col-md-3"><div class="border rounded p-3"><div class="small text-muted">Permessi Brevi</div><div class="fs-4 fw-bold">0</div></div></div>
            <div class="col-6 col-md-3"><div class="border rounded p-3"><div class="small text-muted">Riposi Legge</div><div class="fs-4 fw-bold">0</div></div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- RICERCA -->
    <section id="page-ricerca" class="page">
      <div class="card">
        <div class="card-body">
          <h4 class="mb-3">Ricerca</h4>
          <form id="form-ricerca" class="row g-3">
            <div class="col-12 col-md-3">
              <label class="form-label">Tipo</label>
              <select class="form-select" id="ricerca-tipo">
                <option value="tutti">Tutti</option>
                <option value="turni">Turni</option>
                <option value="assenze">Assenze</option>
                <option value="indennita">Indennità</option>
              </select>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label">Data Da</label>
              <input type="date" class="form-control" id="ricerca-da">
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label">Data A</label>
              <input type="date" class="form-control" id="ricerca-a">
            </div>
            <div class="col-12 col-md-3 d-flex align-items-end">
              <button class="btn btn-primary w-100" type="submit">Cerca</button>
            </div>
          </form>
          <div id="ricerca-risultati" class="mt-3"></div>
        </div>
      </div>
    </section>

  </main>

  <!-- MODAL: Aggiungi Turno -->
  <div class="modal fade" id="modalAddTurno" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="form-add-turno">
        <div class="modal-header">
          <h5 class="modal-title">Aggiungi Turno</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Data</label>
            <input type="date" class="form-control" id="turno-data" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Tipo Turno</label>
            <select class="form-select" id="turno-tipo" required>
              <option value="">Seleziona...</option>
              <option value="sera">Sera</option>
              <option value="pomeriggio">Pomeriggio</option>
              <option value="mattina">Mattina</option>
              <option value="notte">Notte</option>
              <option value="riposo">Riposo</option>
            </select>
          </div>
          <div>
            <label class="form-label">Note</label>
            <textarea class="form-control" id="turno-note" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Annulla</button>
          <button class="btn btn-primary" type="submit">Salva</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL: Aggiungi Indennità -->
  <div class="modal fade" id="modalAddIndennita" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="form-add-indennita">
        <div class="modal-header">
          <h5 class="modal-title">Aggiungi Indennità</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Data</label>
            <input type="date" class="form-control" id="ind-data" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Tipo Indennità</label>
            <select class="form-select" id="ind-tipo" required>
              <option value="">Seleziona...</option>
              <option>Ordine Pubblico</option>
              <option>Servizio Esterno</option>
              <option>Cambio Turno</option>
              <option>Missione</option>
              <option>Reperibilità</option>
              <option>Rimborso Forfettario</option>
              <option>Buono Pasto</option>
              <option>Straordinario Emergente</option>
              <option>Straordinario Programmato</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Importo (€)</label>
            <input type="number" step="0.01" min="0" class="form-control" id="ind-importo" required>
          </div>
          <div>
            <label class="form-label">Note</label>
            <textarea class="form-control" id="ind-note" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Annulla</button>
          <button class="btn btn-primary" type="submit">Salva</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL: Aggiungi Assenza -->
  <div class="modal fade" id="modalAddAssenza" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="form-add-assenza">
        <div class="modal-header">
          <h5 class="modal-title">Aggiungi Assenza</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Data Inizio</label>
            <input type="date" class="form-control" id="ass-start" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Data Fine</label>
            <input type="date" class="form-control" id="ass-end" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Tipo Assenza</label>
            <select class="form-select" id="ass-tipo" required>
              <option value="">Seleziona...</option>
              <option>Congedo Ordinario</option>
              <option>Congedo Straordinario per Malattia</option>
              <option>Congedo Straordinario per Esami</option>
              <option>Congedo Straordinario per Gravi Motivi Familiari</option>
              <option>Congedo Straordinario per Trasferimento</option>
              <option>Riposo Legge</option>
              <option>Riposo Settimanale</option>
              <option>Riposo Festivo</option>
              <option>Riposo Compensativo</option>
              <option>Aspettativa</option>
              <option>Legge 104</option>
              <option>Donazione Sangue</option>
              <option>Ore di Studio</option>
              <option>Permesso Breve</option>
              <option>Permesso Sindacale</option>
            </select>
          </div>
          <div>
            <label class="form-label">Note</label>
            <textarea class="form-control" id="ass-note" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Annulla</button>
          <button class="btn btn-primary" type="submit">Salva</button>
        </div>
      </form>
    </div>
  </div>

  <!-- OVERLAY LOGIN (OTP DEMO) -->
  <div id="auth-overlay">
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <h3 class="mb-3">Accedi</h3>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" id="auth-email" class="form-control" placeholder="nome@dominio.it">
              </div>
              <div class="d-grid gap-2">
                <button class="btn btn-primary" id="btn-send-otp">Invia Codice di Verifica</button>
              </div>
              <hr>
              <div class="mb-2 small text-muted">Demo: Usa il codice <strong>123456</strong> per accedere</div>
              <div class="mb-3">
                <label class="form-label">Codice OTP</label>
                <input type="text" id="auth-otp" class="form-control" inputmode="numeric" pattern="[0-9]*" placeholder="Inserisci 123456">
              </div>
              <div class="d-grid gap-2">
                <button class="btn btn-success" id="btn-verify-otp">Verifica e Accedi</button>
                <button class="btn btn-outline-secondary" id="btn-otp-resend">Invia nuovamente</button>
              </div>
              <div id="auth-msg" class="small text-muted mt-2" aria-live="polite"></div>
            </div>
          </div>
          <p class="text-center text-muted mt-3">Modalità offline attiva - i dati verranno sincronizzati quando tornerai online</p>
        </div>
      </div>
    </div>
  </div>

  <!-- LIBRERIE -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <script>
  /*********************
   * UTIL & STORAGE
   *********************/
  const LS_KEYS = {
    CAL: 'turni_calendario',
    IND: 'indennita_mensili',
    AUTH: 'auth_demo'
  };

  const getJSON = (k, def=[]) => {
    try { return JSON.parse(localStorage.getItem(k) || JSON.stringify(def)); }
    catch { return def; }
  };
  const setJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));

  const fmtISO = d => d.toISOString().slice(0,10);
  const parseISO = s => new Date(s + 'T00:00:00');
  function* daysRange(d1, d2) {
    const cur = new Date(d1.getFullYear(), d1.getMonth(), d1.getDate());
    const end = new Date(d2.getFullYear(), d2.getMonth(), d2.getDate());
    while (cur <= end) { yield new Date(cur); cur.setDate(cur.getDate() + 1); }
  }

  /*********************
   * LOGIN DEMO OTP
   *********************/
  (function authDemo(){
    const overlay = document.getElementById('auth-overlay');
    const btnSend = document.getElementById('btn-send-otp');
    const btnVerify = document.getElementById('btn-verify-otp');
    const btnResend = document.getElementById('btn-otp-resend');
    const inputOTP = document.getElementById('auth-otp');
    const msg = document.getElementById('auth-msg');
    const DEMO_OTP = '123456';

    function hideOverlay(){ overlay.style.display = 'none'; }
    function showOverlay(){ overlay.style.display = ''; }

    // autologin se già autenticato
    if (localStorage.getItem(LS_KEYS.AUTH) === '1') hideOverlay();

    btnSend?.addEventListener('click', (e)=>{ e.preventDefault(); msg.textContent = 'Codice inviato (demo). Usa 123456.'; });
    btnResend?.addEventListener('click', (e)=>{ e.preventDefault(); msg.textContent = 'Nuovo codice inviato (demo): 123456.'; });
    btnVerify?.addEventListener('click', (e)=>{
      e.preventDefault();
      if ((inputOTP.value || '').trim() === DEMO_OTP) {
        localStorage.setItem(LS_KEYS.AUTH, '1');
        hideOverlay();
        window.dispatchEvent(new Event('auth:login'));
      } else {
        msg.textContent = 'Codice errato. Inserisci 123456 per accedere (demo).';
        inputOTP.focus();
      }
    });

    document.getElementById('btn-logout')?.addEventListener('click', ()=>{
      localStorage.removeItem(LS_KEYS.AUTH);
      showOverlay();
    });
  })();

  /*********************
   * NAV TABS
   *********************/
  (function tabs(){
    const pages = document.querySelectorAll('.page');
    document.getElementById('mainTabs')?.addEventListener('click', (e)=>{
      const a = e.target.closest('a[data-target]');
      if (!a) return;
      e.preventDefault();
      document.querySelectorAll('#mainTabs .nav-link').forEach(el=>el.classList.remove('active'));
      a.classList.add('active');
      pages.forEach(p=>p.classList.remove('active'));
      document.getElementById(a.dataset.target)?.classList.add('active');
      if (a.dataset.target === 'page-calendario' && window._calendar) {
        setTimeout(()=>window._calendar.updateSize(), 50);
      }
    });
  })();

  /*********************
   * CHART: Indennità Mensili (sempre visibile)
   *********************/
  (function chartIndennita(){
    const el = document.getElementById('chart-indennita');
    if (!el || typeof Chart === 'undefined') return;

    const stored = getJSON(LS_KEYS.IND, []);
    const labels = stored.length ? stored.map(x=>x.label) : ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
    const values = stored.length ? stored.map(x=>x.value) : Array(12).fill(0);

    const chart = new Chart(el, {
      type: 'line',
      data: { labels, datasets: [{ label: 'Indennità', data: values, tension: 0.3, fill: false }] },
      options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
    });

    window.updateIndennitaChart = function(newData){
      setJSON(LS_KEYS.IND, newData);
      chart.data.labels = newData.map(x=>x.label);
      chart.data.datasets[0].data = newData.map(x=>x.value);
      chart.update();
    };

    window.addEventListener('resize', ()=>chart.resize());
    document.addEventListener('visibilitychange', ()=>!document.hidden && chart.resize());
  })();

  /*********************
   * FULLCALENDAR: sempre visibile
   *********************/
  (function calendario(){
    const el = document.getElementById('calendario-app');
    if (!el || typeof FullCalendar === 'undefined') return;

    const events = getJSON(LS_KEYS.CAL, []); // [] => griglia visibile comunque

    const calendar = new FullCalendar.Calendar(el, {
      initialView: 'dayGridMonth',
      height: 'auto',
      fixedWeekCount: false,
      showNonCurrentDates: true,
      dayMaxEvents: true,
      events
    });
    calendar.render();
    window._calendar = calendar;

    window.refreshCalendarEvents = function(newEvents){
      calendar.removeAllEvents();
      calendar.addEventSource(newEvents);
    };
  })();

  /*********************
   * AGENDA: Generatore turnazione in quinta
   *********************/
  (function agenda(){
    const SEQ = ['sera','pomeriggio','mattina','notte','riposo'];
    const SHIFT_META = {
      sera:       { title: 'Turno sera',       className: 'turno-sera' },
      pomeriggio: { title: 'Turno pomeriggio', className: 'turno-pomeriggio' },
      mattina:    { title: 'Turno mattina',    className: 'turno-mattina' },
      notte:      { title: 'Turno notte',      className: 'turno-notte' },
      riposo:     { title: 'Riposo',           className: 'turno-riposo' }
    };

    function generateRotation({ start, end, startShift }) {
      const startIdx = SEQ.indexOf(startShift);
      if (startIdx < 0) throw new Error('Turno iniziale non valido');

      const events = [];
      let i = 0;
      for (const day of daysRange(start, end)) {
        const tipo = SEQ[(startIdx + i) % SEQ.length];
        const meta = SHIFT_META[tipo];
        events.push({
          id: `auto-${fmtISO(day)}-${tipo}`,
          title: meta.title,
          start: fmtISO(day),
          allDay: true,
          className: meta.className,
          extendedProps: { tipo, origin: 'auto' }
        });
        i++;
      }
      return events;
    }

    function mergeEvents(existing, generated) {
      // protegge quelli manuali (senza origin=auto)
      const manual = existing.filter(e => !(e.extendedProps && e.extendedProps.origin === 'auto'));
      const map = new Map(manual.map(e => [e.id || `${e.start}-${e.title}`, e]));
      for (const ev of generated) {
        map.set(ev.id || `${ev.start}-${ev.title}`, ev);
      }
      return Array.from(map.values());
    }

    // Hook UI
    const $start = document.getElementById('r-start');
    const $end   = document.getElementById('r-end');
    const $sel   = document.getElementById('r-start-shift');
    const $btn   = document.getElementById('r-genera');
    const $out   = document.getElementById('r-esito');

    $btn?.addEventListener('click', ()=>{
      try{
        const ds = $start.value, de = $end.value, shift = $sel.value;
        if (!ds || !de || !shift) throw new Error('Compila data inizio, data fine e turno iniziale.');
        const dStart = parseISO(ds), dEnd = parseISO(de);
        if (dEnd < dStart) throw new Error('La data di fine deve essere successiva a quella di inizio.');
        const gen = generateRotation({ start: dStart, end: dEnd, startShift: shift });

        const existing = getJSON(LS_KEYS.CAL, []);
        const merged = mergeEvents(existing, gen);
        setJSON(LS_KEYS.CAL, merged);

        if (typeof window.refreshCalendarEvents === 'function') window.refreshCalendarEvents(merged);
        window.dispatchEvent(new CustomEvent('turni:generated', { detail: { count: gen.length } }));
        if ($out) $out.textContent = `Generati ${gen.length} turni fino al ${de}.`;
      } catch(err){
        if ($out) $out.textContent = err.message || 'Errore durante la generazione.';
        else alert(err.message || 'Errore durante la generazione.');
      }
    });

    // Agenda list
    function renderAgendaList(containerSelector) {
      const el = document.querySelector(containerSelector);
      if (!el) return;
      const events = getJSON(LS_KEYS.CAL, [])
        .filter(e => e.extendedProps?.tipo) // solo turni
        .sort((a,b)=> (a.start < b.start ? -1 : 1));

      el.innerHTML = '';
      for (const ev of events) {
        const d = new Date(ev.start);
        const item = document.createElement('div');
        item.className = 'border rounded p-3';
        item.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-bold">${d.toLocaleDateString('it-IT', { weekday:'long', day:'2-digit', month:'long', year:'numeric' })}</div>
              <div class="text-muted small">${ev.title}</div>
            </div>
            <div class="d-flex gap-3">
              <a href="#" class="link-primary" data-del="${ev.id}">Elimina</a>
            </div>
          </div>
        `;
        el.appendChild(item);
      }

      // delete handler
      el.querySelectorAll('[data-del]')?.forEach(a=>{
        a.addEventListener('click', (e)=>{
          e.preventDefault();
          const id = a.getAttribute('data-del');
          let arr = getJSON(LS_KEYS.CAL, []);
          arr = arr.filter(x => (x.id || `${x.start}-${x.title}`) !== id);
          setJSON(LS_KEYS.CAL, arr);
          if (typeof window.refreshCalendarEvents === 'function') window.refreshCalendarEvents(arr);
          renderAgendaList(containerSelector);
        });
      });
    }

    document.addEventListener('DOMContentLoaded', ()=>renderAgendaList('#agenda-list'));
    window.addEventListener('turni:generated', ()=>renderAgendaList('#agenda-list'));
  })();

  /*********************
   * FORM: Aggiungi Turno / Indennità / Assenza (semplice)
   *********************/
  (function forms(){
    // Turno
    document.getElementById('form-add-turno')?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const data = document.getElementById('turno-data').value;
      const tipo = document.getElementById('turno-tipo').value;
      if (!data || !tipo) return;
      const titleMap = { sera:'Turno sera', pomeriggio:'Turno pomeriggio', mattina:'Turno mattina', notte:'Turno notte', riposo:'Riposo' };
      const events = getJSON(LS_KEYS.CAL, []);
      const id = `man-${data}-${tipo}-${Math.random().toString(36).slice(2,8)}`;
      events.push({ id, title: titleMap[tipo] || tipo, start: data, allDay:true, extendedProps:{ tipo, origin:'manual' } });
      setJSON(LS_KEYS.CAL, events);
      if (typeof window.refreshCalendarEvents === 'function') window.refreshCalendarEvents(events);
      document.querySelector('#modalAddTurno .btn-close').click();
    });

    // Indennità (aggiorna grafico con somma semplice per mese)
    document.getElementById('form-add-indennita')?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const data = document.getElementById('ind-data').value;
      const importo = parseFloat(document.getElementById('ind-importo').value||'0');
      if (!data || isNaN(importo)) return;

      const d = new Date(data+'T00:00:00');
      const month = d.toLocaleString('it-IT', { month:'short' });
      const labelsDefault = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];

      const arr = getJSON(LS_KEYS.IND, labelsDefault.map(l=>({label:l, value:0})));
      const idx = arr.findIndex(x => x.label.toLowerCase().startsWith(month.slice(0,3).toLowerCase()));
      if (idx >= 0) arr[idx].value += importo;
      setJSON(LS_KEYS.IND, arr);
      if (typeof window.updateIndennitaChart === 'function') window.updateIndennitaChart(arr);
      document.querySelector('#modalAddIndennita .btn-close').click();
    });

    // Assenza (solo persist/placeholder per estensioni future)
    document.getElementById('form-add-assenza')?.addEventListener('submit', (e)=>{
      e.preventDefault();
      document.querySelector('#modalAddAssenza .btn-close').click();
    });
  })();

  /*********************
   * PWA: Service Worker (facoltativo)
   *********************/
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(()=>{});
  }
  </script>
</body>
</html>
